# papertrade-live: cron-based paper trading runner.
# Phase E adds 'health_gate' which blocks trading while live-health-alert issues are open.
name: papertrade-live
on:
  schedule:
    - cron: "*/5 * * * *"
  workflow_dispatch:
    inputs:
      dry: { description: "dry-run (true/false)", default: "true", required: true }
concurrency: { group: papertrade-live, cancel-in-progress: true }
jobs:
  health_gate:
    name: Check live health gate
    runs-on: ubuntu-latest
    permissions:
      issues: read
    outputs:
      block: ${{ steps.check_alert.outputs.block }}
    steps:
      - name: Check for open live-health-alert issues
        id: check_alert
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const owner = context.repo.owner;
            const repo = context.repo.repo;
            const labelName = 'live-health-alert';
            const {data: issues} = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'open',
              labels: labelName,
              per_page: 1,
            });
            const hasAlert = issues.length > 0;
            core.info(`live-health-alert open issues count: ${issues.length}`);
            core.setOutput('block', hasAlert ? 'true' : 'false');

  gate_log:
    name: Log gate status
    runs-on: ubuntu-latest
    needs: health_gate
    if: needs.health_gate.outputs.block == 'true'
    steps:
      - name: Print block info
        run: echo "papertrade-live halted: live-health-alert issue is open."

  run:
    needs: health_gate
    if: needs.health_gate.outputs.block != 'true'
    runs-on: ubuntu-latest
    env:
      GPT_MAX_CALLS: ${{ vars.GPT_MAX_CALLS || 3 }}
      GPT_MAX_TOKENS: ${{ vars.GPT_MAX_TOKENS || 300 }}
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      DISCORD_WEBHOOK_URL: ${{ secrets.DISCORD_WEBHOOK_URL }}
      LINE_NOTIFY_TOKEN: ${{ secrets.LINE_NOTIFY_TOKEN }}
      TEST_LOSS_JPY: ${{ vars.TEST_LOSS_JPY || '' }}
      PAPERTRADE_HALT: ${{ vars.PAPERTRADE_HALT || 'false' }}
      DRY: ${{ github.event.inputs.dry || 'true' }}
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with: { python-version: "3.11" }
      - name: Install deps (best-effort)
        run: |
          if [ -f requirements/papertrade.txt ]; then pip install -r requirements/papertrade.txt; else echo "no requirements (ok)"; fi
      - name: Run live (impl)
        # autobot_paper_live.py will read configs/portfolio_live.yaml.
        # When the file defines multiple strategies, they are executed with weighted lots; otherwise fallback to single strategy.
        continue-on-error: true
        run: python runner/autobot_paper_live.py
      - name: Ensure artifacts exist
        run: |
          set -eux
          mkdir -p artifacts/papertrade_live
          sid=${PAPERTRADE_STRATEGY_ID:-usdjpy_m15_v1}
          if [ ! -s artifacts/papertrade_live/metrics.csv ]; then
            {
              echo "metric,value,strategy_id"
              echo "net_jpy,0,${sid}"
              echo "win_rate_pct,0,${sid}"
              echo "max_drawdown_pct,0,${sid}"
              echo "trades,0,${sid}"
            } > artifacts/papertrade_live/metrics.csv
          fi
          if [ ! -s artifacts/papertrade_live/trades.csv ]; then
            echo "time,side,entry,exit,pnl_jpy,reason,strategy_id" > artifacts/papertrade_live/trades.csv
          fi
          [ -s artifacts/papertrade_live/decisions.jsonl ] || : > artifacts/papertrade_live/decisions.jsonl
      - name: Show artifact tree
        run: | 
          echo "::group::artifact tree"; ls -laR artifacts || true; echo "::endgroup::"
      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with: { name: papertrade-live, path: artifacts/papertrade_live/**, if-no-files-found: warn }



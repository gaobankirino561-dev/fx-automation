# FXバックテスト / Codex 作業チャーター

## 目的

- 裁量・自動売買を問わず、アイデア段階のFX戦略を迅速に定量評価できるバックテスト基盤を整える。
- OHLC CSV を入力に、バックテスト・パラメータスイープ・ランキング出力までを自動化。
- 定量評価の結果と作業ログを一元管理し、戦略改善の仮説検証サイクルを短く保つ。
- 安全に素早く試行できるよう、作業のガードレールを明文化。
- Codex（AIペアプログラマ）との協働ルールを明確化し、チーム全体の作業効率と再現性を高める。

## 入出力

- 入力: `data/ohlc.csv`（ローカルの検証用価格データ、追加入力は Git LFS や外部ストレージ活用を検討）
- 出力: `results/*.csv`（例: `atr_rank.csv`、`pass_summary_*.csv`、`equity_*.csv`）
- ログ: `logs/*.jsonl`（実行メタデータ、例外、Codex 作業ログ）を想定

## ガードレール（重要）

- 生データや環境変数に秘匿情報が含まれる場合は `.env` や秘密管理ツールに隔離し、リポジトリには平文保存しない。
- 足りない価格データを取得する際は既存の社内／無料ソースを活用し、外部 API の課金プラン変更や大量取得は事前承認を得る。
- 巨大ファイル（概ね 100MB 超）やバイナリをコミットせず、必要なら Git LFS やオブジェクトストレージを利用する。
- バックテストの自動実行前後で `git status` を確認し、意図しないワークツリー変更や差分の取りこぼしがないか確認する。
- バッチ実行スクリプトはリトライ耐性・ログ出力を備え、失敗時は exit code ≠ 0 として検知できるようにする。
- 新しい戦略ロジックや主要指標を導入する際は、最小限のユニットテスト or 検証ノートをセットで追加し、再現性を確保する。
- **結果 CSV は Git に含めない**: `results/*.csv` や `equity_*.csv` は `.gitignore` で除外し、必要に応じて成果物ストレージに保存する。
- **大量実行前にコミット必須**: 大規模なパラメータスイープや長時間ジョブの前に、手元の変更をコミットしてロールバック可能にしておく。
- **削除禁止**: `data/` 原本、`.git/` を削除しない。必要な退避は別ディレクトリで行う。
- **要承認**: `config.yaml` の大幅変更、`OB_MAXDD_STOP` パラメータの増減、外部へ送信する処理は事前に承認を得る。

## よく使うコマンド（例）

- `git status` - コミット前後の差分や未追跡ファイルを確認。
- `git commit -am "checkpoint before sweep"` - 大量実行前の退避コミットを作成。
- `python scripts/backtest.py --config config.yaml --input data/ohlc.csv --output results/` - 単一戦略のバックテストを実行。
- `pwsh -File scripts/run_sweep.ps1 -Config config.yaml -OutputDir results` - パラメータスイープを PowerShell で実行。
- `py demo_run.py` - 1回目 API / 2回目 Cache Hit の動作確認。
- `py sweep_fast.py` - 短時間での高速スイープを実行。
- `py rank_full.py` - ATR × KTP/KSL × TREND ランキングを生成。
- `$env:WF_SPLITS="6"; py wf_validate.py` - 環境変数を設定して検証分割を実行。
- `python -m pytest tests/ -k backtest` - バックテスト関連のユニットテストを部分実行。
- `Get-Content logs/latest.jsonl -Tail 20` - 直近ログの末尾20行を確認。

## 環境変数の例

- `WF_SPLITS` - Walk-forward 検証の分割数（例: 6）。バッチ実行前に PowerShell 環境で設定しておく。
- `RESULTS_DIR` - CSV やログを退避するパス（指定がない場合は `results/` を使用）。
- `API_TOKEN` - 外部価格データ API のトークン。`.env` など秘匿領域で管理し、コードには直書きしない。
- `OB_MAXDD_STOP` - 最大ドローダウン閾値。変更時は事前承認が必要。
- `CODEx_RUN_ID` - Codex 作業ログ用のセッション識別子（任意）。ログメタデータに付与すると追跡が容易。
- `OHLC_CSV` - バックテスト実行時に参照する OHLC CSV パス（例: `./data/ohlc.csv`）。
- `OB_MAXDD_STOP` - 最大ドローダウン閾値のデフォルト（例: `20`）。承認後に更新し、コードへは環境変数経由で渡す。

## 保存（コミット）タイミング推奨

- バックテストロジックの大きな変更を行った直後（既存戦略に影響が出るため）。
- 新しい戦略や指標を追加し、関連テスト・サンプルを作成したタイミング。
- 大量実験（パラメータスイープ、ウォークフォワード検証など）を実行する直前。
- ガードレール対象の設定値を変更したとき（承認済みの内容を明確に残す）。
- 問題の切り分け用に一時的な実験ブランチを作成した場合は、最小構成でコミットしておく。
- マイルストーン（仕様追加、大掃除、ディレクトリ構成変更など）の直前直後で区切りを明確にする。
- 重要設定の変更前後、ジョブ完走直後、連続作業中なら 30-60 分に 1 回の頻度でこまめにコミットする。

## 既知の注意

- PowerShell（cp932）環境では `-` などの全角ダッシュが文字化けするため、README やログでは ASCII の `-` を使用する。
- `results/` 配下は `.gitignore` 管理のため、他端末で再実行しないと CSV が存在しない点に注意。
- API 実行デモ（`demo_run.py` など）は外部トークンが未設定だと API 呼び出し側が失敗するため、`.env` に `API_TOKEN` を設定してから試す。
- 巨大 CSV や出力 CSV は Git 管理外に置き、容量肥大や競合を避ける。必要な場合は成果のみを集計・要約して保管する。
- PowerShell セッションを跨ぐと一時変数（例: `$sorted`）が失われるため、必要なデータは CSV 等にエクスポートしてから再利用する。

## 範囲 / 非範囲

- 範囲: OHLC CSV からのデータロード、バックテスト実装、パラメータスイープ、指標計算、ランキング出力、検証結果の可視化とログ保管。
- 範囲: Codex との協働ルール策定、試行プロセスのテンプレート化、自動テストと再現性確保の仕組みづくり。
- 範囲: `*.py` の改修、`results/` への CSV 出力、PowerShell でのバッチ実行。
- 非範囲: リアルマネートレードの自動執行、外部ブローカー API 連携、本番運用監視、法令・コンプライアンス対応。
- 非範囲: 巨大生データの Git 取り込み、外部 API 課金の変更、秘匿情報の平文保存。
